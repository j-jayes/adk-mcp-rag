<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Morocco">
<meta name="dcterms.date" content="2025-10-07">

<title>BA’s Best Lasagna</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-1d4f84655f446305ac42a8f1abcf7405.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BA’s Best Lasagna</h1>
  <div class="quarto-categories">
    <div class="quarto-category">recipes</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Morocco </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 7, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="blurb" class="level2">
<h2 class="anchored" data-anchor-id="blurb">Blurb</h2>
<p>This lasagna recipe has “rainy Sunday cooking project” written all over it. But, if you’re into meal prep, you can make the cheesy béchamel and the meaty ragù ahead and pop them into the fridge or freezer. You can also assemble a tray of homemade lasagna in advance and freeze it unbaked for at least a month (and probably longer). The secret weapon is the meat sauce. You might ask: Why in the world would we tell you to make meatballs, brown them, and then break them into pieces after simmering for hours in tomato sauce? Sounds crazy, we know. Searing the meat in ball form helps you develop deep color (a.k.a. flavor) while allowing moisture to evaporate in the spaces between the balls. Mashing a bunch of ground meat into the bottom of your pot, however, would trap the steam and ultimately take longer to brown. And why do you need to crush canned whole tomatoes when crushed tomatoes are sitting right there on the grocery store shelf? We like a chunky tomato sauce, and there’s no standard for cans labeled “crushed”—they may be chunky, but they could also be a full-on purée. Better to take matters into your own hands. (Watch more of Chris’s rationalizing here.) If you want to use fresh pasta, go for it. We also tested the recipe with no-boil lasagna noodles, but found they soak up too much sauce, leading to a baked pasta that tastes dry without all that wonderful ooziness. Our ultimate pick is De Cecco lasagna sheets. This is a project recipe, to be sure. If you want to go all out, round it out with garlic bread and a classic Caesar salad. Looking for something a little lighter lift? Try our Italian-sausage-loaded Cottage Cheese Lasagna, which blows versions made with ricotta cheese out of the water. All products featured on Bon Appétit are independently selected by our editors. However, when you buy something through the retail links below, we earn an affiliate commission.</p>
</section>
<section id="ingredients" class="level2">
<h2 class="anchored" data-anchor-id="ingredients">Ingredients</h2>
<ul>
<li>2 lb. ground pork</li>
<li>1 lb. ground beef chuck (20% fat)</li>
<li>Kosher salt, freshly ground black pepper</li>
<li>2 Tbsp. extra-virgin olive oil</li>
<li>2 oz. pancetta (Italian bacon) or slab bacon, chopped</li>
<li>1 medium onion, finely chopped</li>
<li>1 celery stalk, finely chopped</li>
<li>1 medium carrot, peeled, finely chopped</li>
<li>6 garlic cloves, sliced</li>
<li>2 Tbsp. tomato paste</li>
<li>¾ cup dry white wine</li>
<li>1 28-oz. can whole peeled tomatoes</li>
<li>1 cup low-sodium chicken broth</li>
<li>1 cup whole milk</li>
<li>7 Tbsp. unsalted butter</li>
<li>¼ cup plus 3 Tbsp. all-purpose flour</li>
<li>6 cups whole milk</li>
<li>4 oz. Parmesan cheese, coarsely grated (about 1 cup)</li>
<li>Pinch of cayenne pepper</li>
<li>Pinch of ground nutmeg</li>
<li>Kosher salt, freshly ground black pepper</li>
<li>1¼ lb. dried lasagna noodles (preferably De Cecco)</li>
<li>Extra-virgin olive oil (for greasing)</li>
</ul>
</section>
<section id="instructions" class="level2">
<h2 class="anchored" data-anchor-id="instructions">Instructions</h2>
<ol type="1">
<li>Preheat oven to 225°. Mix 2 lb. ground pork and 1 lb. ground beef chuck (20% fat) with your hands in a large bowl; season generously with kosher salt and freshly ground black pepper, then mix again. Form into about 18 large meatballs (they don’t need to be perfect—you’ll be mashing them later).</li>
<li>Warm 2 Tbsp. extra-virgin olive oil in a large Dutch oven or other heavy pot over medium-high heat. Working in 2 batches, cook meatballs, turning occasionally and reducing heat if bottom of pot looks in danger of scorching, until browned all over, about 6 minutes per batch. Transfer to a rimmed baking sheet as they’re done.</li>
<li>Reduce heat to medium. Add 2 oz. pancetta (Italian bacon) or slab bacon, chopped, to pot and cook, stirring often, until lightly browned and beginning to crisp, about 5 minutes. Add 1 medium onion, finely chopped, 1 celery stalk, finely chopped, 1 medium carrot, peeled, finely chopped, and 6 garlic cloves, sliced, and cook, stirring occasionally, until vegetables are softened, 6–8 minutes. Add 2 Tbsp. tomato paste and cook, stirring constantly, until paste is darkened in color, about 2 minutes.</li>
<li>Add ¾ cup dry white wine and cook, stirring occasionally, until almost completely evaporated, about 5 minutes. Add one 28-oz. can whole peeled tomatoes, crushing with your hands, and increase heat to medium-high. Cook, stirring occasionally, until liquid is jammy and reduced by about half, 8–10 minutes. Add 1 cup low-sodium chicken broth and 1 cup whole milk, then return meatballs to pot. Bring to a simmer. Cover pot partially with a lid, transfer to oven, and cook, checking every hour or so to ensure liquid is at a low simmer and adjusting oven temperature as needed, until meatballs are falling-apart tender, 3–4 hours.</li>
<li>Using a potato masher, break meatballs apart and incorporate into liquid (you should have about 8 cups ragù; transfer pot to stovetop and simmer gently to reduce if needed). Taste and season with more salt and black pepper if needed. Do ahead: Ragù can be made 4 days ahead. Let cool; cover and chill, or freeze up to 3 months.</li>
<li>Melt 7 Tbsp. unsalted butter in a large saucepan over medium heat. Whisk in ¼ cup plus 3 Tbsp. all-purpose flour and cook, whisking occasionally, until mixture smells slightly nutty, about 4 minutes. Quickly whisk in 6 cups whole milk, then increase heat to medium-high and bring to a simmer, whisking constantly. Reduce heat to maintain a simmer and cook, whisking occasionally, until béchamel thickens, about 4 minutes. Continue to cook, whisking occasionally and adjusting heat as needed to maintain a gentle simmer, until béchamel is smooth and velvety, 8–10 minutes more. Remove from heat and whisk in 4 oz. Parmesan cheese, coarsely grated (about 1 cup), a pinch of cayenne pepper, and a pinch of ground nutmeg. (You should have about 6 cups béchamel.) Season with kosher salt and freshly ground black pepper. Transfer to a large bowl and press plastic wrap directly onto surface; let cool slightly.</li>
<li>Preheat oven to 325°. Cook 1¼ lb. dried lasagna noodles in a large pot of boiling salted water, stirring occasionally and separating them so they don’t stick together, until just starting to soften but still snap in half rather than bend when folded; 3 minutes is the magic number. The noodles will be so firm it will just seem all wrong, but this is what separates al dente lasagna layers from gummy ones. Using tongs, transfer noodles to a large bowl of cold water to cool. Drain and lie flat in a single layer on a rimmed baking sheet, separated by parchment or wax paper.</li>
<li>Lightly coat a 13x9” glass or ceramic baking dish with extra-virgin olive oil. Spread 1½ cups ragù in dish. Lay a single layer of noodles over ragù (you will need to cut some noodles in half in order to fill all gaps). Spoon 1¼ cups béchamel over noodles, spreading in an even layer with a small offset spatula. Top béchamel with 1½ cups of meat sauce. Starting with another layer of noodles, repeat process, creating 5 layers of pasta (or 6, depending on how deep your pan is) in total and ending with remaining 1 cup béchamel. Lasagna should come right to the top edge of dish.</li>
<li>Cover with a lightly oiled piece of aluminum foil and set lasagna pan on a rimmed baking sheet (just to catch drips). Bake lasagna until bubbling gently around the edges, about 1 hour. Remove from oven. Increase oven temperature to 425° and carefully place rack in top of oven. Remove foil from lasagna and continue to bake until top is browned and crisp around the edges, 10–15 minutes longer. Let sit 10 minutes before serving. Do ahead: Béchamel can be made 1 day ahead; keep chilled. Rewarm just enough to loosen before using. Lasagna can be assembled 1 month ahead; let cool, then cover with plastic and freeze. Let frozen lasagna thaw overnight in fridge before baking.</li>
</ol>
</section>
<section id="end-blurb" class="level2">
<h2 class="anchored" data-anchor-id="end-blurb">End-blurb</h2>
<p>Editor’s note: This homemade lasagna recipe was first printed in our February 2018 issue. Head this way for more of our comfort food favorites →</p>
</section>
<section id="comments" class="level2">
<h2 class="anchored" data-anchor-id="comments">Comments</h2>
<ul>
<li>First time making a lasagna with béchamel due to my wife not liking ricotta. BTW her mom makes lasagna with cottage cheese. Yuck! This is definitely a labor of love but worth the effort. I added pesto to my béchamel and it make a nice addition to this already great recipe.</li>
<li>This turned out well, it was a 2 day process and assembly felt a bit chaotic. If you make the ragu ahead of time I found it difficult to spread easily when it was cold. I recommend reheating it so the oils and juices of the tomato make it more easily spreadable. The bechamel had problems, although I found it more easily spread with my fingers than a spatula - an offset icing spatula is probably what you need. No problem with the lasagna noodles sticking although I used a store brand not de cecco. The chopping of the vegetables took 45 min (I doubled the ragu recipe to make one to stash in the freezer). I chopped my vegetables very finely and I’m glad I did, I thought of using the food processor but didn’t want to create too moisture I’d have to cook off and extend the cooking time even more.</li>
<li>is everyone ok?? literally do not understand the discourse. this lasagna is very good, if you don’t think so you’re a liar or you’re bad at cooking?? sorry!!!</li>
<li>This recipe is a real winner. The second time I made this, I substituted hot Italian sausage – casing removed – for the pork, added lots of ribboned basil, and threw three cups of spinach into the ragu.</li>
<li>This recipe truly is delicious if you’re willing to put in the work. I too had an issue with the number of layers, but if you smush them down, you should be able to get at least five in a 9x13 pan.</li>
<li>This was a labour of love. Made the Bolognese one day, the bechamel the next and assembled the third day. For the Bolognese, used a pound of sweet Italian sausage and a pound of hot (casings removed). I believe my error was using fresh lasagna sheets as the end result, while it looked fantastic in the pan, did not serve as per the picture, more a sloppy mess. I think next time - and there will definitely be a next time - I will put the noodles in uncooked so they absorb the extra moisture and the lasagna will serve nicer. Mind you, our guests were close to licking their plates as they all said best lasagna ever!!! Had no issues with the bechamel as others seem to have. Did add another cup of parmesan for additional cheeseyness.</li>
<li>For those of you bad mouthing this recipe, I have been married to a first generation Italian for 42 years and this is exactly how my mother in law, grandmother in law, and all of the aunties have always made their lasagna. The family emigrated here 70 years ago and this is the recipe they brought with them. Different regions make foods differently. From North to South, there are variations on so many dishes. Don’t discount a recipe just because it’s not the way you’ve always made something.</li>
<li>I can’t believe the arrogance of some of these comments! Just because it isn’t how you, your mother or nonna made it doesn’t make it wrong and certainly doesn’t mean someone isn’t a serious or even a good cook, it just means they make it differently! Here it is: lasagna with ricotta and mozzarella is a southern variation, whereas bechamel and bolognese is a northern variation. A quick Google search will help you understand that both versions coexist. My mother-in-law makes hers with meatballs, my grandfather did not. One with meat sauce, the other’s sauce without. Both were to die for! Personally, I like bechemel and bolognese, no meatballs. It make the lasagna so rich and decadent that you don’t notice the lack of ricotta. That said, I would never disparage someone who makes it differently and neither should you. Be nice! Max Mariola: https://www.youtube.com/watch?v=BxmTu5FJP-g Marcella Hazan: https://www.nytimes.com/2003/04/14/dining/cooking/lasagna-the-recipe.html</li>
<li>Might be tasty but my Italian mother in law wouldn’t ever make it with bechemel or boxed pasta. Ricotta, mozzarella, Parmesan, eggs, fresh parsley and homemade pasta are absolutely essential. Her “gravy” was absolutely smooth, cooked with pork bones, meatballs, and sausages. I guess it all depends on which province a serious Italian cook originates from.</li>
<li>This is the best lasagna bolognese recipe. Chris Morocco perfected the timing, quantity, and method. I use a Staub dutch oven to cook the meatballs, and it comes out perfectly. The way they break down into a bolognese sauce is brilliant. I have also swapped out cow’s milk for cashew milk (and vegan butter) to make the bechamel sauce, as I have a friend that can’t have cow’s milk (but can eat parmesan reggiano), and there was no difference from the cow’s milk version. Even if the bechamel is not as thick as a cow’s milk version, you cannot tell when using in the lasagna. This recipe is my go to for bolognese sauce period. I will make some and freeze it to use whenever I need to pull the emergency bolognese switch.</li>
<li>Tastes good but a lot of work and I took shortcuts!</li>
<li>This was a lot of work, to not a great reward. I couldn’t fit all of the ragu into the pan with the number of layers called for. That was the main problem, as well as the bechamel taking much longer to thicken as others have mentioned. The end result was a pretty dry lasagna that had some nice flavor but wasn’t pleasing, considering every other lasagna I’ve had in my life. There was a particular lack of tamato flavor. It was more like ground meat with vegetable bits in pasta.</li>
<li>This recipe is perfection. I’m officially converted to bechemel lasagna. Only suggestions I’d make is salt everything really well along the way and I used quick cook noodles and put them in dry and it turned out perfectly</li>
<li>I don’t know if I’ll ever be able to eat jar sauces again or buy a Stouffers Lasagna! SO delicious! Very complicated though, so if you aren’t a home “chef”:, I don’t advise trying this recipe cause you will be in the kitchen ALL. DAY. LONG. Didn’t realize before I hurriedly read over the recipe to head to the store that A) it doesn’t have ricotta cheese or mozzarella and B) it was going to take all day to make. That being said, I told my husband if it didn’t tun out, I would never try another Lasagna recipe again. Tried a homemade lasagna 10-12 years ago and it was time consuming and tasted flavorless. This lasagna recipe was absolutely worth every minute I spent in the kitchen. AND of course, like every recipe, you have to tweak it a little to make it your own. Everybody likes something different, but one thing is for sure, this bolognese rage is loaded with flavor! I did add a few more cloves of garlic because I’m a garlic lover. I did add a little mozzarella to the top after the béchamel because it didn’t feel right not have cheese on the top. I didn’t see where there were specific directions on how not to cook the noodles all the way, and I cooked the noodles all the way. That being said, I will try to do it the night way next time. It wasn’t terrible the way I made it either though. I just reduced the sauce further to thicken it since I didn’t have raw noodles to absorb it. Next time, I will likely split my time in the kitchen and cook the sauce one day and complete the meal, the next.</li>
<li>This recipe took a long time, but it was worth it. Made it with a friend and we agree, easily the best meal either of us have ever cooked. Following the instructions is really simple for a home cook and it came out better than either of us could have expected! The light spices really shine in the bolognese, the béchamel was a little bit concerning - as we were both expecting there to be more cheese and béchamel is intimidating - but it was much, much better, than any lasagna I have ever had, wether cooked by my mom or the finest restaurant (sorry mom). I cannot say enough how excellent this recipe is. Chris and the team at BA have really outdone themselves with this one. The only complaint that we have is that I wish it were somehow bigger, we inevitably will be making this with as much frequency as we can. I am no longer eager for lasagna made by any other recipe. Please do yourself a favor and make this dish, any negative comments must respectfully be the result of a mistake made by the cook. Amazing! Amazing! Amazing!</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Claire Saffitz">
<meta name="dcterms.date" content="2025-10-07">

<title>BA’s Best Coconut Cream Pie</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-1d4f84655f446305ac42a8f1abcf7405.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BA’s Best Coconut Cream Pie</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Dessert</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Claire Saffitz </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 7, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="blurb" class="level2">
<h2 class="anchored" data-anchor-id="blurb">Blurb</h2>
<p>Think of this coconut cream pie recipe from pastry chef and former BA staffer Claire Saffitz as a Samoa cookie in pie form. It’s crunchy, caramelly, creamy, and positively jam-packed with coconut in all its many forms. You’ll find toasted coconut in the quick-and-dirty homemade pie crust, coconut oil in the caramel, coconut milk in the custard, and of course, flaked coconut to top it all off. (Catch Claire making the pie here.)This recipe takes time and is best approached in stages. Start with the graham cracker pie shell, which comes together with a quick blitz in a food processor, and gets a brief blind bake. Bundled in plastic wrap, it can be left out at room temperature for a day or frozen in the pie plate for up to two weeks. The coconut caramel, which adds that signature Samoa chew to the pie, can be made up to four days in advance.Save the creamy coconut filling for the day of serving—or one day before, max. Claire swaps out vanilla extract for a whole vanilla bean to really amp up the flavor, and uses half-and-half instead of whole milk for a richer mouthfeel. Once the pie filling’s poured into the crust, cover with plastic wrap (it should touch the custard!) so it doesn’t form a film and refrigerate.For the very last step, whipped cream goes perfectly with this coconut cream pie, but if you want to use up the extra egg whites, make a marshmallow topping. Bonus: You can torch it, for even more drama.For more custard pies, check out our recipes for Banana Cream Pie, Extremadura Almond Pie, Key Lime Pie, or Milk and Honey Pie.Think of this like a Samoa cookie in pie form. It’s perfect with whipped cream on top, but if you want to use up the extra egg whites, make a marshmallow topping. Bonus: You can torch it, for even more drama.</p>
</section>
<section id="ingredients" class="level2">
<h2 class="anchored" data-anchor-id="ingredients">Ingredients</h2>
<ul>
<li>1¼ cups unsweetened finely shredded coconut</li>
<li>4 ounces graham crackers (about 7), lightly crushed</li>
<li>2 tablespoons sugar</li>
<li>¼ teaspoon kosher salt</li>
<li>¼ cup (½ stick) unsalted butter, melted, cooled</li>
<li>1 large egg yolk</li>
<li>⅓ cup sugar, divided</li>
<li>¼ cup heavy cream</li>
<li>2 tablespoons virgin coconut oil, melted</li>
<li>½ teaspoon kosher salt</li>
<li>3 tablespoons virgin coconut oil, room temperature</li>
<li>1 vanilla bean, split lengthwise</li>
<li>1 13.5-ounce can unsweetened coconut milk, shaken</li>
<li>1 cup half-and-half</li>
<li>1 large egg</li>
<li>4 large egg yolks</li>
<li>3 tablespoons cornstarch</li>
<li>¼ teaspoon kosher salt</li>
<li>½ cup plus 2 tablespoons sugar</li>
<li>1½ cups heavy cream</li>
<li>Toasted coconut flakes (for serving)</li>
<li>A 9-inch deep pie dish; a candy thermometer</li>
</ul>
</section>
<section id="instructions" class="level2">
<h2 class="anchored" data-anchor-id="instructions">Instructions</h2>
<ol type="1">
<li>Preheat oven to 350°. Arrange coconut in a thin, even layer on a rimmed baking sheet and bake, stirring halfway through, until golden brown, 5–8 minutes; let cool. Set aside ½ cup toasted coconut for the coconut caramel.</li>
<li>Pulse graham crackers, sugar, salt, and remaining ¾ cup toasted coconut in a food processor until crackers are coarsely ground. With the motor running, stream in butter, followed by yolk. Do not overprocess; you should have fine crumbs that are the texture of wet sand.</li>
<li>Transfer mixture to pie dish and press firmly and evenly up sides and across the bottom. Place pan on a rimmed baking sheet and bake until crust is set and edges are brown, 12–18 minutes. Let cool.</li>
<li>Do Ahead: Crust can be baked 1 day ahead. Let cool, wrap in plastic, and store at room temperature, or freeze up to 2 weeks.</li>
<li>Sprinkle a thin, even layer of sugar into a small heavy saucepan. Cook, undisturbed, over medium heat until mostly melted, about 3 minutes. Sprinkle another layer of sugar over and cook, stirring to incorporate granular sugar into melted sugar with a heatproof spatula, until melted, another minute or so. Repeat until you’ve used all sugar. Continue to cook, swirling saucepan (do not stir), until caramel is dark amber, about 30 seconds longer. Remove from heat and carefully pour in cream, stirring to combine (caramel will sputter and seize up, but don’t worry).</li>
<li>Return saucepan to low heat and cook, stirring, until any hardened bits of caramel are dissolved. Stir in oil until mixture is smooth, then fold in salt and reserved ½ cup toasted coconut. Let caramel cool in pan, then scrape into cooled crust and use an offset spatula to spread in an even layer. Cover with plastic and chill.</li>
<li>Do Ahead: Caramel can be made 4 days ahead. Transfer to an airtight container and chill. Rewarm over low heat before pouring into pie crust.</li>
<li>Place oil in a medium bowl and set a fine-mesh sieve over top; set aside. Scrape vanilla seeds into a heavy medium saucepan. Add vanilla pod and coconut milk. Bring to a simmer over medium heat and cook, stirring occasionally, until coconut milk is reduced to about 1 cup, 10–15 minutes. Add half-and-half and bring to a gentle simmer.</li>
<li>Meanwhile, briskly whisk egg, yolks, cornstarch, salt, and ½ cup sugar in another medium bowl until pale and thick, about 1 minute. Whisking constantly, slowly pour about ½ cup hot milk mixture into egg mixture. Go back to whisking milk mixture in saucepan, then slowly pour tempered egg mixture into saucepan. Cook over medium heat, whisking constantly, until foam has subsided and custard holds the marks of the whisk, about 2 minutes.</li>
<li>Immediately scrape custard into sieve and use a spatula to press mixture into bowl with oil; pluck out vanilla pod. Whisk strained custard until oil is incorporated and mixture is glossy and smooth.</li>
<li>Set bowl inside another large bowl of ice water. Whisk occasionally until custard is cool, about 3 minutes. Scrape custard into chilled pie crust and smooth top. Press a piece of plastic directly onto surface of custard to prevent a skin from forming, and chill until set, at least 3 hours.</li>
<li>Using an electric mixer on medium-high speed, beat cream in a large bowl until soft peaks form. Whisk in remaining 2 tablespoons sugar.</li>
<li>Remove plastic from surface of pie and dollop cream over set custard. Top with coconut flakes.</li>
<li>Do Ahead: Pie can be filled with custard 1 day ahead. Wrap in plastic and chill. Top with whipped cream and toasted coconut just before serving.</li>
</ol>
</section>
<section id="end-blurb" class="level2">
<h2 class="anchored" data-anchor-id="end-blurb">End-blurb</h2>
<p>Editor’s note: This recipe was originally published in May 2017 as part of BA’s Best, a collection of our essential recipes. Head this way for more of our favorite cream pie recipes →</p>
</section>
<section id="comments" class="level2">
<h2 class="anchored" data-anchor-id="comments">Comments</h2>
<ul>
<li>Yummmm. This pie was heavenly! I followed the recipe with no substitutions, and had no troubles with the caramel. Fairly experienced home baker, with no formal training. Like a lot if bon appetit recipes, you have to tap into your foundations knowledge (although Claire provides pretty clear instructions in this one). Tip for the caramel- try letting the heavy cream come up to room temp before adding it, it won’t seize up the sugar as much and will blend in easier with less heat, which will keep the caramel from being overcooked and burnt tasting or hard. Like others noticed, the coconut flavor in the cream layer was mild, but I loved that because it let the salty, coconutty, caramel and crust shine. I think the light whipped cream was the right choice, as a heavy, sweet meringue would have been a lot. I’ll find something else for those egg whites :)</li>
<li>Are you able to convert your measurements and temperatures for australian measurements? This cake looks.awesome!</li>
<li>My family loves this recipe, and I make it for my husband’s birthday every year. It’s delicious.</li>
<li>I have had this recipe set aside for several years, but finally decided to make it for Thanksgiving. The results were perfect. The crust eats more like a semi-crunchy coconut cookie. You can pick up this piece of pie with your fingers and eat like a piece of pizza. I actually loved that. The caramel portion came out perfect. It was on the soft chewy side - I noticed that it blended into the crust and/or was moistened by the cream filling. Certainly if you overcook caramel, it will either turn to be like hard candy OR it will be burned. Love the light texture change and flavor addition there. *I added about 3 TBL of toasted unsweetened coconut flakes on top of the caramel layer. Turned out to be genius for extra flavor. I actually made two pies, one with whipped cream and one with toasted Italian Meringue. I loved them both.</li>
<li>This pie is fantastic! Takes a while to put together and lots of steps, but worth every minute you’ll spend on not. The only problem is the caramel. Made as directed it isn’t enough and it gets so hard on the bottom of the pie, you can’t cut it. I recommend more caramel and more cream in that caramel, so it’s not so hard. I make one cup of sugar, melted in 1/4 cup of water. Cooked to a golden brown, then 1/2 cup of heavy cream, 2 tbsp of coconut oil, and the toasted coconut. Delicious, and cuttable! I don’t use all of that caramel in the pie. It’s too much. But it’s delicious on ice cream, or in any place you might like a coconutty caramel sauce.</li>
<li>I love it! I made it yesterday in 8 cm tart rings because I want to send it to my friends for the New Year gift. The coconut flavor is subtle and it pairs beautifully with custard, caramel and the crust. I couldn’t find Graham Crackers in my country so I used coconut biscuits instead and omit the sugar, because the biscuits are already sweet. It’s a complicated recipe, but it sure does worth it. Thanks!</li>
<li>Unusually for me I followed the recipe nearly exactly, changing only the vanilla bean for a whack of vanilla paste. This pie is FANTASTIC. One of the best pies I ever tasted - made it first time yesterday for dinner company and they hoovered it like wolves, all gone. I’m an experienced home cook but not trained, and had no issues with any of the steps. Mine is full of coconut flavour so not sure why any would find it bland. Well done, Claire; I’m sure I’ll make this many times!</li>
<li>Amazing. I added a layer of coconut chocolate ganache on top of the caramel (recipe from Epicurious).</li>
<li>This is literally the best pie I’ve ever had. I made this for my family and they won’t stop raving about it! The only change I made to the recipe is that I used brown butter for the pie crust, but I don’t think it made much of a difference.</li>
<li>This recipe is BOMB. And I would like to address some of the older comments about people failing at making the caramel. I had the same issues, and I tried 3 different times. The last time worked well all because I had a heavy bottom pot that held more heat and allowed the cream to incorporate into the caramel. It has to stay warm! Or it will turn to hard candy caramel and REALLY seize up!</li>
<li>I never liked coconut cream pie until this recipe. I love coconut but felt most coconut cream pies were bland with little coconut flavor. I love how this recipe packs coconut into everything from the crust to the caramel to the filling. After reading the reviews, I did add a teaspoon of coconut extract to the filling which I thought was a welcome addition. Every time I’ve made it, I’ve found the coconut toasts fairly quickly (around 4 minutes). I initially burnt a few batches of coconut flakes. The crust was also on the lower end of the 12-18 for me - would just keep a close eye out. This is a fairly involved recipe and fairly time consuming. I think it’s best to make it a day ahead and keep in the fridge overnight. Best to give the filling plenty of time to set. I have made this recipe multiple times and will keep it as a standby!</li>
<li>i love Claire’s Coconut Cream Pie recipe so much, i pinned it twice! i’d add more coconut to both crust and custard, but i love the simple whipped cream topping. less sweet and more creamy than the meringue i thought she was going to make, what with all those egg whites just sitting around! Claire – you are a baking genius! – so much knowledge and experience; just a great teacher! (psst – whenever there are leftover egg whites, … MERINGUE COOKIES!)</li>
<li>Yum! This was simply amazing! Everyone who ate it said it was the best coconut pie they’ve ever had. I personally don’t like coconut cream pie, but I loved this. Just a couple things I would mention. First I would beat the egg yolk then stream it into the food processor. Next the caramel. Like the recipe says it will seize up, don’t worry just keep stirring. I wouldn’t serve this straight from the fridge or the caramel might be a bit chewy. Just set it out for an hour or so and it’s wonderful.</li>
<li>The pie was delish! My complain would be like most, the caramel layer. It was hard and super chewy. I would adjust that for sure. Other than that the pie was delicious. Flavor was there. Coconut-y but not overpowering.</li>
<li>Oh Claire the things you do to me. I have made very few pies in my life. This pie was so good, even better the day after. Her caramel method didn’t work for me (which I came to accept after 2 tries) so I went with the wet caramel method and added 1/4 cup water to 1/3 cup sugar and let that caramelize which was perfect. All in all a crowd pleaser. Subtle coconut flavour but definitely there, and not too sweet. I did actually omit a bit of sugar from the custard which I could’ve eaten all of straight out of the bowl.</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>